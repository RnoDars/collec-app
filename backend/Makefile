.PHONY: help test test-unit test-e2e test-coverage run dev

# Variables
GO=go
GOTEST=$(GO) test
APP_NAME=collec-app-backend

help: ## Afficher l'aide
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

test: ## Ex√©cuter tous les tests
	$(GOTEST) -v ./...

test-unit: ## Ex√©cuter uniquement les tests unitaires (sans E2E)
	$(GOTEST) -v $$(go list ./... | grep -v /test/e2e)

test-e2e: ## Ex√©cuter les tests end-to-end (n√©cessite serveur en cours d'ex√©cution)
	@echo "‚ö†Ô∏è  Assurez-vous que le serveur est d√©marr√© sur http://localhost:8080"
	@echo "   Commande: make run (dans un autre terminal)"
	@echo ""
	$(GOTEST) -v ./test/e2e/...

test-coverage: ## Ex√©cuter les tests avec couverture (unitaires seulement)
	$(GOTEST) -coverprofile=coverage.out $$(go list ./... | grep -v /test/e2e)
	$(GO) tool cover -html=coverage.out -o coverage.html
	@echo "üìä Rapport de couverture g√©n√©r√© : coverage.html"

run: ## D√©marrer le serveur
	$(GO) run cmd/api/main.go

dev: ## D√©marrer le serveur en mode d√©veloppement (avec air si install√©)
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "‚ö†Ô∏è  'air' n'est pas install√©. Installation recommand√©e : go install github.com/air-verse/air@latest"; \
		echo "   D√©marrage avec 'go run' √† la place..."; \
		$(GO) run cmd/api/main.go; \
	fi

build: ## Compiler l'application
	$(GO) build -o bin/$(APP_NAME) cmd/api/main.go

clean: ## Nettoyer les fichiers g√©n√©r√©s
	rm -f coverage.out coverage.html
	rm -rf bin/

deps: ## T√©l√©charger les d√©pendances
	$(GO) mod download
	$(GO) mod tidy

.DEFAULT_GOAL := help
