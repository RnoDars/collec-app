# Plan de d√©veloppement v0.2.0 - Authentification

**Date de cr√©ation :** 30/12/2025
**Objectif :** Syst√®me d'authentification JWT complet avec inscription, connexion, et profil utilisateur

## üéØ Scope Fonctionnel

### Fonctionnalit√©s incluses
- ‚úÖ Inscription utilisateur (email + mot de passe)
- ‚úÖ Connexion avec JWT (access token + refresh token)
- ‚úÖ D√©connexion avec invalidation des tokens
- ‚úÖ Affichage du profil (lecture seule)
- ‚úÖ Protection des routes backend et frontend
- ‚úÖ Redirection vers homepage apr√®s connexion

### Fonctionnalit√©s report√©es
- ‚è≥ Remember me
- ‚è≥ Modification de profil
- ‚è≥ V√©rification email
- ‚è≥ R√©cup√©ration mot de passe

## üìã T√¢ches Backend (GoLang)

### 1. Base de donn√©es

#### 1.1 Mod√®le User
**Fichier :** `backend/internal/models/user.go`
```go
type User struct {
    ID        uuid.UUID `gorm:"type:uuid;primary_key"`
    Email     string    `gorm:"uniqueIndex;not null"`
    Password  string    `gorm:"not null"` // Hash bcrypt
    CreatedAt time.Time
    UpdatedAt time.Time
}
```

#### 1.2 Migration
**Fichier :** `backend/migrations/001_create_users_table.sql`
- Table users avec contraintes
- Index sur email

**Commande :** `golang-migrate` pour g√©rer les migrations

### 2. Repository Layer

#### 2.1 User Repository
**Fichier :** `backend/internal/repository/user_repository.go`

**M√©thodes :**
- `Create(user *models.User) error`
- `FindByEmail(email string) (*models.User, error)`
- `FindByID(id uuid.UUID) (*models.User, error)`
- `ExistsByEmail(email string) (bool, error)`

**Tests :** `backend/internal/repository/user_repository_test.go`
- Mocks de la DB avec testify/mock
- Tests pour chaque m√©thode
- Tests des cas d'erreur

### 3. Service Layer

#### 3.1 Auth Service
**Fichier :** `backend/internal/service/auth_service.go`

**M√©thodes :**
- `Register(email, password string) (*models.User, error)`
  - Valider email et mot de passe
  - V√©rifier que l'email n'existe pas
  - Hasher le mot de passe (bcrypt, cost 10)
  - Cr√©er l'utilisateur

- `Login(email, password string) (accessToken, refreshToken string, error)`
  - Trouver l'utilisateur par email
  - V√©rifier le mot de passe
  - G√©n√©rer access token (15 min)
  - G√©n√©rer refresh token (7 jours)

- `RefreshToken(refreshToken string) (newAccessToken string, error)`
  - Valider le refresh token
  - G√©n√©rer nouveau access token

- `ValidateToken(token string) (*jwt.Claims, error)`
  - Valider et parser le JWT

**D√©pendances :**
- `golang-jwt/jwt/v5` pour JWT
- `golang.org/x/crypto/bcrypt` pour hash password
- UserRepository

**Tests :** `backend/internal/service/auth_service_test.go`
- Mock du repository
- Tests pour chaque m√©thode
- Tests des cas d'erreur

#### 3.2 User Service
**Fichier :** `backend/internal/service/user_service.go`

**M√©thodes :**
- `GetUserByID(id uuid.UUID) (*models.User, error)`
- `GetUserProfile(id uuid.UUID) (*dto.UserProfileDTO, error)`

**Tests :** `backend/internal/service/user_service_test.go`

### 4. API Layer

#### 4.1 DTOs (Data Transfer Objects)
**Fichier :** `backend/internal/dto/auth_dto.go`

```go
type RegisterRequest struct {
    Email    string `json:"email" validate:"required,email"`
    Password string `json:"password" validate:"required,min=8"`
}

type LoginRequest struct {
    Email    string `json:"email" validate:"required,email"`
    Password string `json:"password" validate:"required"`
}

type AuthResponse struct {
    AccessToken  string `json:"accessToken"`
    RefreshToken string `json:"refreshToken"`
    User         UserDTO `json:"user"`
}

type RefreshTokenRequest struct {
    RefreshToken string `json:"refreshToken" validate:"required"`
}

type UserDTO struct {
    ID        string    `json:"id"`
    Email     string    `json:"email"`
    CreatedAt time.Time `json:"createdAt"`
}
```

#### 4.2 Auth Handler
**Fichier :** `backend/internal/handler/auth_handler.go`

**Endpoints :**
- `POST /api/auth/register` - Inscription
- `POST /api/auth/login` - Connexion
- `POST /api/auth/logout` - D√©connexion
- `POST /api/auth/refresh` - Refresh token
- `GET /api/auth/me` - Profil utilisateur (prot√©g√©)

**R√©ponses :**
- 200 OK avec donn√©es
- 400 Bad Request (validation)
- 401 Unauthorized
- 409 Conflict (email existe d√©j√†)
- 500 Internal Server Error

**Tests :** `backend/internal/handler/auth_handler_test.go`
- Tests HTTP avec httptest
- Mock du service

#### 4.3 User Handler
**Fichier :** `backend/internal/handler/user_handler.go`

**Endpoints :**
- `GET /api/users/profile` - Afficher son profil (prot√©g√©)

### 5. Middleware

#### 5.1 Auth Middleware
**Fichier :** `backend/internal/middleware/auth_middleware.go`

**Fonction :** `AuthRequired()`
- Extraire le token du header Authorization
- Valider le token JWT
- Extraire l'user ID des claims
- Ajouter l'user ID au contexte
- Retourner 401 si invalide

**Tests :** `backend/internal/middleware/auth_middleware_test.go`

### 6. Configuration

#### 6.1 JWT Config
**Fichier :** `backend/internal/config/config.go`

**Ajouts :**
```go
type JWTConfig struct {
    Secret               string
    AccessTokenDuration  time.Duration // 15min
    RefreshTokenDuration time.Duration // 7 jours
}
```

**Variables d'environnement :**
```
JWT_SECRET=your-secret-key-min-32-chars
JWT_ACCESS_DURATION=15m
JWT_REFRESH_DURATION=168h
```

#### 6.2 Database Config
**Ajout de la connexion PostgreSQL avec GORM**

**D√©pendances :**
```
go get gorm.io/gorm
go get gorm.io/driver/postgres
go get github.com/google/uuid
```

### 7. Routes

#### 7.1 Router Setup
**Fichier :** `backend/internal/router/router.go`

```go
// Routes publiques
authGroup := r.Group("/api/auth")
{
    authGroup.POST("/register", authHandler.Register)
    authGroup.POST("/login", authHandler.Login)
    authGroup.POST("/logout", authHandler.Logout)
    authGroup.POST("/refresh", authHandler.RefreshToken)
}

// Routes prot√©g√©es
authGroup.GET("/me", middleware.AuthRequired(), authHandler.GetMe)

userGroup := r.Group("/api/users")
userGroup.Use(middleware.AuthRequired())
{
    userGroup.GET("/profile", userHandler.GetProfile)
}
```

### 8. Validation

**Utiliser :** `go-playground/validator/v10`
- Validation automatique des DTOs
- Messages d'erreur personnalis√©s en fran√ßais

## üìã T√¢ches Frontend (Next.js + TypeScript)

### 1. Types TypeScript

#### 1.1 Types Auth
**Fichier :** `frontend/src/types/auth.ts`

```typescript
export interface User {
  id: string;
  email: string;
  createdAt: string;
}

export interface LoginRequest {
  email: string;
  password: string;
}

export interface RegisterRequest {
  email: string;
  password: string;
}

export interface AuthResponse {
  accessToken: string;
  refreshToken: string;
  user: User;
}
```

### 2. API Client

#### 2.1 Auth API
**Fichier :** `frontend/src/lib/api/auth.ts`

**Fonctions :**
- `register(data: RegisterRequest): Promise<AuthResponse>`
- `login(data: LoginRequest): Promise<AuthResponse>`
- `logout(): Promise<void>`
- `refreshToken(): Promise<string>`
- `getMe(): Promise<User>`

**Utiliser :** `fetch` ou `axios` avec gestion des erreurs

### 3. State Management

#### 3.1 Auth Store (Zustand)
**Fichier :** `frontend/src/store/auth-store.ts`

**State :**
```typescript
interface AuthState {
  user: User | null;
  accessToken: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;

  // Actions
  login: (data: LoginRequest) => Promise<void>;
  register: (data: RegisterRequest) => Promise<void>;
  logout: () => Promise<void>;
  setUser: (user: User) => void;
  setTokens: (accessToken: string, refreshToken: string) => void;
}
```

**Persistence :** Stocker les tokens dans localStorage ou cookies s√©curis√©s

### 4. Components

#### 4.1 Forms

**Fichier :** `frontend/src/components/auth/login-form.tsx`
- Formulaire avec React Hook Form + Zod validation
- Champs : email, password
- Bouton submit avec √©tat loading
- Affichage des erreurs

**Fichier :** `frontend/src/components/auth/register-form.tsx`
- Formulaire avec React Hook Form + Zod validation
- Champs : email, password, confirm password
- Validation c√¥t√© client (email, min 8 chars)
- Bouton submit avec √©tat loading

**Fichier :** `frontend/src/components/auth/profile-card.tsx`
- Affiche les infos utilisateur (email, date cr√©ation)
- Bouton d√©connexion

#### 4.2 Layout

**Fichier :** `frontend/src/components/layout/navbar.tsx`
- Affiche email de l'utilisateur si connect√©
- Boutons Login/Register si non connect√©
- Bouton D√©connexion si connect√©

### 5. Pages

#### 5.1 Auth Pages

**Fichier :** `frontend/src/app/auth/login/page.tsx`
- Page de connexion
- LoginForm
- Lien vers page d'inscription

**Fichier :** `frontend/src/app/auth/register/page.tsx`
- Page d'inscription
- RegisterForm
- Lien vers page de connexion

**Fichier :** `frontend/src/app/profile/page.tsx`
- Page profil (prot√©g√©e)
- ProfileCard
- Affiche les infos utilisateur

#### 5.2 Home Page Update

**Fichier :** `frontend/src/app/page.tsx`
- Afficher message de bienvenue si connect√©
- Sinon afficher boutons Login/Register

### 6. Protection des Routes

#### 6.1 Auth Guard
**Fichier :** `frontend/src/components/auth/auth-guard.tsx`

```typescript
// HOC ou composant qui v√©rifie l'authentification
// Redirige vers /auth/login si non authentifi√©
```

#### 6.2 Middleware Next.js
**Fichier :** `frontend/src/middleware.ts`

- V√©rifier le token dans les cookies
- Prot√©ger les routes `/profile`, `/dashboard` (future)
- Rediriger vers `/auth/login` si non authentifi√©

### 7. API Interceptor

#### 7.1 Token Refresh Automatique
**Fichier :** `frontend/src/lib/api/interceptor.ts`

- Intercepter les r√©ponses 401
- Essayer de refresh le token automatiquement
- Retry la requ√™te initiale avec nouveau token
- Si √©chec, d√©connecter et rediriger vers login

### 8. Validation Schemas

#### 8.1 Zod Schemas
**Fichier :** `frontend/src/lib/validations/auth.ts`

```typescript
export const loginSchema = z.object({
  email: z.string().email("Email invalide"),
  password: z.string().min(1, "Mot de passe requis"),
});

export const registerSchema = z.object({
  email: z.string().email("Email invalide"),
  password: z.string().min(8, "Minimum 8 caract√®res"),
  confirmPassword: z.string(),
}).refine(data => data.password === data.confirmPassword, {
  message: "Les mots de passe ne correspondent pas",
  path: ["confirmPassword"],
});
```

## üß™ Tests

### Backend
- Tests unitaires pour chaque layer (repository, service, handler)
- Tests d'int√©gration pour les endpoints
- Couverture minimum : 80%

### Frontend
- Tests des composants avec React Testing Library
- Tests des formulaires avec validation
- Tests du store Zustand
- Mock des API calls avec MSW

## üìö Documentation

### API Documentation
- Swagger/OpenAPI pour tous les endpoints auth
- Exemples de requ√™tes/r√©ponses
- Codes d'erreur document√©s

### README Updates
- Section "Authentification" ajout√©e
- Exemples d'utilisation de l'API
- Instructions pour tester

## üîÑ Ordre d'impl√©mentation recommand√©

1. **Backend - Base de donn√©es**
   - Mod√®le User
   - Migration
   - Repository

2. **Backend - Services**
   - Auth Service (register, login, tokens)
   - User Service

3. **Backend - API**
   - DTOs
   - Handlers
   - Middleware
   - Routes

4. **Backend - Tests**
   - Tests unitaires
   - Tests d'int√©gration

5. **Frontend - Base**
   - Types
   - API client
   - Store Zustand

6. **Frontend - UI**
   - Formulaires (login, register)
   - Pages
   - Protection routes

7. **Frontend - Tests**
   - Tests composants
   - Tests formulaires

8. **Documentation**
   - Swagger
   - README

## ‚úÖ Crit√®res d'acceptation

- [ ] Un utilisateur peut s'inscrire avec email/password
- [ ] Un utilisateur peut se connecter
- [ ] Un utilisateur connect√© peut voir son profil
- [ ] Un utilisateur peut se d√©connecter
- [ ] Les routes prot√©g√©es redirigent vers login si non authentifi√©
- [ ] Le token se refresh automatiquement
- [ ] Les mots de passe sont hash√©s en bcrypt
- [ ] Les tokens JWT sont sign√©s correctement
- [ ] Tests backend : couverture > 80%
- [ ] Tests frontend : composants critiques couverts
- [ ] Documentation Swagger compl√®te
- [ ] Commits atomiques r√©guliers

---

**Estimation :** 2-3 jours de d√©veloppement
**Prochaine √©tape :** Commencer par le backend (base de donn√©es + mod√®les)
